# Платформа для отслеживания и симуляции торговли валютами

Это комплексная платформа на Python, которая позволяет пользователям регистрироваться, управлять своим виртуальным портфелем фиатных и криптовалют, совершать симуляционные сделки по покупке/продаже, а также отслеживать актуальные курсы в реальном времени.

Система построена на принципах чистой архитектуры и состоит из двух логических сервисов:

Основной Сервис (Core Service): Главное приложение, которое предоставляет пользовательский интерфейс (CLI), управляет пользователями, их кошельками, историей транзакций и взаимодействует с сервисом парсинга для получения актуальных курсов.

Сервис Парсинга (Parser Service): Компонент, который по запросу обращается к публичным API, получает актуальные курсы, сравнивает их с предыдущими значениями и сохраняет в локальный кэш.

Для получения данных используются следующие внешние API:

- Криптовалюты: CoinGecko API https://www.coingecko.com/en/api 

- Фиатные валюты: ExchangeRate-API https://www.exchangerate-api.com/.

---

## Структура проекта

```
Проект имеет следующую структуру каталогов:
├── data/ # JSON файлы для хранения данных (пользователи, портфели, курсы)
├── logs/ # Файлы логов
├── valutatrade_hub/
│ ├── cli/ # Логика командной строки (interface.py)
│ ├── core/ # Ядро бизнес-логики (модели, usecases, исключения)
│ ├── infra/ # Инфраструктурный слой (база данных, настройки)
│ └── parser_service/ # Сервис для получения курсов с внешних API
├── .env # Файл для хранения секретных ключей (API)
├── .gitignore
├── Makefile # Команды для управления проектом
├── main.py # Главная точка входа
├── poetry.lock
├── pyproject.toml # Зависимости и конфигурация проекта
└── README.md
```

## Установка и запуск

### 1. Установка зависимостей

Проект использует `poetry` для управления зависимостями. Для установки выполните команду:
```bash
make install
```

Эта команда создаст виртуальное окружение и установит все необходимые пакеты.

### 2. Настройка Parser Service

Для получения курсов фиатных валют (EUR, RUB и т.д.) приложению требуется доступ к `ExchangeRate-API`.

1.  **Создайте файл `.env`** в корневой директории проекта.
2.  **Добавьте** в него ваш API ключ:

    ```
    EXCHANGERATE_API_KEY="ВАШ_КЛЮЧ_С_САЙТА"
    ```

Если ключ не будет предоставлен, приложение будет использовать курсы криптовалют от `CoinGecko` и резервные (fallback) курсы для некоторых фиатных валют.

---

## Использование

### Запуск приложения

Приложение запускается в интерактивном режиме. Внутри него можно вводить команды с их аргументами.
```bash
poetry run project
```
После запуска вы увидите приглашение >.
Парсинг команд с помощью shlex
Для надежного разбора команд, введенных пользователем, используется стандартная библиотека shlex. Функция shlex.split() корректно разделяет строку на команду и ее аргументы, правильно обрабатывая пробелы и кавычки, что похоже на поведение настоящей командной строки Unix. Это позволяет избежать ошибок при парсинге сложных аргументов, например, паролей со спецсимволами.

---

### Основные команды

*   **Регистрация нового пользователя:**
    ```
    register --username <имя> --password <пароль>
    ```

*   **Обновление курсов валют:**
    ```
    update-rates
    ```

*   **Просмотр доступных курсов:**
    ```
    show-rates
    ```
    *Дополнительные флаги:* `--currency <КОД>`, `--top <N>`

*   **Просмотр портфеля:**
    ```
    show-portfolio
    ```
    *Дополнительные флаги:* `--base <ВАЛЮТА>` (например, `--base EUR`)

*   **Покупка валюты:**
    ```
    buy --currency <КОД> --amount <сумма>
    ```

*   **Продажа валюты:**
    ```
    sell --currency <КОД> --amount <сумма>
    ```
---
## Кэширование и TTL (Time-To-Live)

Для снижения нагрузки на внешние API и ускорения работы, курсы валют кэшируются в файле `data/rates.json`.

*   **TTL (Время жизни кэша):** По умолчанию, кэш считается актуальным в течение 1 часа (3600 секунд), как указано в `UPDATE_INTERVAL_SECONDS` в файле `valutatrade_hub/parser_service/config.py`.
*   **Принудительное обновление:** Команда `update-rates` всегда загружает свежие данные и перезаписывает кэш, игнорируя TTL.
*   **Резервные курсы:** Если кэш пуст или недоступен, а API не отвечают, система использует жестко закодированные резервные курсы из `valutatrade_hub/core/usecases.py` для обеспечения базовой функциональности.

---

### Дополнительные команды `Makefile`

*   **Проверка и исправление стиля кода:**
    ```
    make lint-fix
    ```
## Демонстрация работы

[![Демонстрация работы "ValutaTrade Hub"](https://asciinema.org/a/xw5zOzY2HJ3yUb5aBSFeTvOKQ.svg)](https://asciinema.org/a/xw5zOzY2HJ3yUb5aBSFeTvOKQ)

